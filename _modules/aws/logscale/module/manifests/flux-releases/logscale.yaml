apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: logscale
spec:
  interval: 10m
  timeout: 5m
  chart:
    spec:
      chart: logscale
      version: "7.0.0-next.119"
      sourceRef:
        kind: HelmRepository
        name: logscale-contrib-ls
        namespace: flux-system
      interval: 5m
  releaseName: logscale
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  test:
    enable: false
  driftDetection:
    mode: warn
    ignore:
      - paths: ["/spec/replicas"]
        target:
          kind: Deployment
  dependsOn:
    - name: kafka-topics
  valuesFrom:
    - kind: ConfigMap
      name: clustervars
      valuesKey: platformType
      targetPath: platform.provider
    - kind: ConfigMap
      name: clustervars
      valuesKey: platformType
      targetPath: humio.buckets.type
    - kind: ConfigMap
      name: clustervars
      valuesKey: aws_region
      targetPath: humio.buckets.region
    - kind: ConfigMap
      name: clustervars
      valuesKey: aws_region
      targetPath: humio.buckets.region
    - kind: ConfigMap
      name: logscalevars
      valuesKey: bucket_storage
      targetPath: humio.buckets.storage
    - kind: ConfigMap
      name: logscalevars
      valuesKey: bucket_prefix
      targetPath: humio.buckets.prefix
    - kind: ConfigMap
      name: logscalevars
      valuesKey: kafka_prefix
      targetPath: humio.kafka.topicPrefix
    - kind: ConfigMap
      name: logscalevars
      valuesKey: logscale_sa_name
      targetPath: humio.serviceAccount.name
    - kind: ConfigMap
      name: logscalevars
      valuesKey: logscale_sa_arn
      targetPath: humio.serviceAccount.annotations.eks\.amazonaws\.com/role-arn
    - kind: ConfigMap
      name: logscalevars
      valuesKey: logscale_license
      targetPath: humio.license
    - kind: ConfigMap
      name: logscalevars
      valuesKey: fqdn
      targetPath: humio.fqdn
    - kind: ConfigMap
      name: logscalevars
      valuesKey: fqdn_ingest
      targetPath: humio.fqdnInputs

    - kind: ConfigMap
      name: logscalevars
      valuesKey: saml_url
      targetPath: humio.auth.saml.signOnUrl
    - kind: ConfigMap
      name: logscalevars
      valuesKey: saml_issuer
      targetPath: humio.auth.saml.entityID
    - kind: ConfigMap
      name: logscalevars
      valuesKey: saml_signing_certificate
      targetPath: humio.auth.saml.idpCertificate

  values:
    fullnameOverride: logscale

    humio:
      image:
        tag: 1.118.2
      kafka:
        manager: external
        prefixEnable: true
        bootstrap: kafka-kafka-bootstrap:9092

      config:
        enableInternalLogger: "true"
      auth:
        rootUser: ryan.faircloth@crowdstrike.com
        method: saml
        saml:
          groupMembershipAttribute: http://schemas.xmlsoap.org/claims/Group
        # saml:
        #   signOnUrl: https://identity.ref.logsr.life/application/saml/partition-logscale/sso/binding/redirect/
        #   entityID: authentik
        #   idpCertificate: MIIFVDCCAzygAwIBAgIRAPsOT5aynkQ7tWNkjQKuz8AwDQYJKoZIhvcNAQELBQAwHjEcMBoGA1UEAwwTYXV0aGVudGlrIDIwMjMuMTAuNjAeFw0yNDAxMjAxODEyMjdaFw0yNTAxMjAxODEyMjdaMFYxKjAoBgNVBAMMIWF1dGhlbnRpayBTZWxmLXNpZ25lZCBDZXJ0aWZpY2F0ZTESMBAGA1UECgwJYXV0aGVudGlrMRQwEgYDVQQLDAtTZWxmLXNpZ25lZDCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBALxnmyn0Rc3XRVRyrIoZn+6BE9WjORqvKTT+n93tbdtXZ85ghc6pa8s/Tb28pbHD9KYM382lCv7LyDBYmHuWGjOl/h+C/cnICQiIMFpbSv0thXJ/rUD2pTJ0ka/vterMWu50wTCXh1vxITi6fxIWqyQJ90kKBZ9O5AkBgLF/K+C8GV+0HR2b6NsjZtWVOW6JmtqowdwsR64v0upZ0TtLNI/X7ujKdTlAH5Ycq0/gv41SNSFj2uomod+t19SWhhE7eoDfhKQaV7cOeHsTIPRd0YRpcBL16IdhjqQlEZeHnc0Pa3GbuZxS1l6/3rmszUbpaQaiy1VVAByVRoPFTrxRnmQwkiX1Ib4a2vZPAWMeVmQYxht53BqslY4HdoBcfQ70jhmm6rghI9jD0J/wcHLhW+eAVgZI67tB1XQjzN9nvxGhRZFWTkhKU8bJYFrmESGXU7N8lC4SQ03FLLHUO6HRVJN4IwU4K51n5vPOBl2CFQxAC+3IlKPmDRo+IFvYm8bkhIT3ExjY+RYJFVvpgY2dF9517W4yKYQ5DeWzAKCNS9YlWCvhZP8XAxuB4/+xKSLeJvpx/bUEfGXh3ZmFQbmImWL/3iv2uL7E5olcZK/cTgABcsnUkVGNBIQbEyjRfqo5ZHxZXqgSz9yw4Nlfc5FVXcIOcBXieBCk+nlh+ggDwgUbAgMBAAGjVTBTMFEGA1UdEQEB/wRHMEWCQ0FqenU1WTMyaUNQMVY1ZkVBaml1NFdsMDh4Vkp2UXVFRkpZWVp3MVQuc2VsZi1zaWduZWQuZ29hdXRoZW50aWsuaW8wDQYJKoZIhvcNAQELBQADggIBABMLQCj3nuGr1zaDm1Ig4fgteN6BTHgSdJ150BePOJ+GxPMZH4xJm7UbTHjtdZ6gWBA5UdhC3LNGOlsTStHmAbwbUkD5dYEYXXEGT0ZU6pCgmAWVf56fEV7+lkHcq+/zVeOU877R+W2s7no+dZl/Ev/sLmjMt+YrB9BMBSGiD1PKY72As/eWLXD+2yu8skBFDh2UB4XZkI3aoLrma4odRE0PEDjXk09frmsTrZ/2u8wSMyT/Lkrs7zfywp1Zn4mmQpCjrhA8uuW08ezzc7+WC9nj9RkKy6Yrrpxt5rwpCb39z4swUE7uKtgBnBw3g0po0YIrVQVVAdgzV4htjURBRFcWhzfWOHP0eDomnQZ+IOmZyWKynyY/74ZIzC/9yEcMoIfkh5Wk1dfnuTVbSyyioDeL3wqRMXIJqsoaRgaFkZ55bo/xFHHKicMjJO8Fs8Em2l3OPPW1kKjGsQkWWBXl8KDbdUhXFusNIiFzIEZazxUj7D/CBdllnaJAsPqY/QDSdUjjDJY90+zC0Vz9v3eE1/ZOCx0AAGQNUE5/kGDqFv7hZAHcUiH0WPDoyrnWNdFsCxTU/xRVmx3AN7hDBT8f8j1Uyv4oiQ8lxsRBRHIU01X35+Erd5StUDKycXNGboVpa9OeDYqrqDeBcMUaBLbCNT1ZxJxJ9NxbLDXASh/3cV+D

      nodeCount: 3
      #In general for these node requests and limits should match
      resources:
        requests:
          memory: 24Gi
          cpu: 2
        limits:
          memory: 24Gi
          cpu: 2
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: "kubernetes.io/arch"
                    operator: "In"
                    values: ["amd64"]
                  - key: "kubernetes.io/os"
                    operator: "In"
                    values: ["linux"]
                  - key: "karpenter.k8s.aws/instance-local-nvme"
                    operator: Gt
                    values:
                      - "910"
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: humio.com/node-pool
                    operator: In
                    values:
                      - "logscale"
                      - "logscale-ingest-only"
                      - "logscale-http-only"
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - "zookeeper"
                      - "kafka"
              topologyKey: "kubernetes.io/hostname"
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchExpressions:
              - key: humio.com/node-pool
                operator: In
                values:
                  - logscale
      tolerations:
        - key: topolvm.io/local
          operator: "Equal"
          value: "true"
      dataVolumePersistentVolumeClaimSpecTemplate:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: "900Gi"
        # storageClassName: "gp3"
        storageClassName: "nvme-xfs"
      frontEndDataVolumePersistentVolumeClaimSpecTemplate:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: "10Gi"
        storageClassName: "gp3"
      priorityClass: partition-high

      ingress:
        ui:
          className: alb-partition
          enabled: true
          tls: true
          annotations:
            alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'
            alb.ingress.kubernetes.io/ssl-redirect: "443"
        inputs:
          className: alb-partition
          enabled: true
          tls: true
          annotations:
            alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'
            alb.ingress.kubernetes.io/ssl-redirect: "443"

      nodepools:
        ingest:
          priorityClass: partition-medium
          nodeCount: 3
          resources:
            limits:
              cpu: "2"
              memory: 3Gi
            requests:
              cpu: "2"
              memory: 3Gi
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: "kubernetes.io/arch"
                        operator: "In"
                        values: ["amd64"]
                      - key: "kubernetes.io/os"
                        operator: "In"
                        values: ["linux"]
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: humio.com/node-pool
                        operator: In
                        values:
                          - "logscale"
                          - "logscale-ingest-only"
                          - "logscale-http-only"
                  topologyKey: "kubernetes.io/hostname"
          topologySpreadConstraints:
            - maxSkew: 1
              topologyKey: topology.kubernetes.io/zone
              whenUnsatisfiable: DoNotSchedule
              labelSelector:
                matchExpressions:
                  - key: humio.com/node-pool
                    operator: In
                    values:
                      - logscale-ingest-only
        ui:
          priorityClass: partition-low
          nodeCount: 3
          resources:
            limits:
              cpu: "2"
              memory: 3Gi
            requests:
              cpu: "2"
              memory: 3Gi
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: "kubernetes.io/arch"
                        operator: "In"
                        values: ["amd64"]
                      - key: "kubernetes.io/os"
                        operator: "In"
                        values: ["linux"]
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: humio.com/node-pool
                        operator: In
                        values:
                          - "logscale"
                          - "logscale-ingest-only"
                          - "logscale-http-only"
                  topologyKey: "kubernetes.io/hostname"
          topologySpreadConstraints:
            - maxSkew: 1
              topologyKey: topology.kubernetes.io/zone
              whenUnsatisfiable: DoNotSchedule
              labelSelector:
                matchExpressions:
                  - key: humio.com/node-pool
                    operator: In
                    values:
                      - "logscale-http-only"
